# Project Persistence Implementation Plan - REVISION 2

## Goal

Implement **auto-save** behavior like Screen Studio - all changes are automatically persisted to disk immediately. No manual save buttons needed.

---

## Key Insight from Screen Studio Example

Screen Studio's `project.json` has:

- `lastSavedAt` timestamp that updates on each save
- Project is saved to a permanent location immediately when recording ends
- All edits are auto-saved to disk

**The workflow should be:**

1. Recording ends → User chooses where to save the `.osp` bundle (once)
2. All subsequent edits are auto-saved to that location
3. No "Save" button - just "Open" to load existing projects

---

## Changes Required (from current implementation)

### Remove

- Save button from EditorView header
- `isDirty` state tracking (no longer needed)
- `UnsavedChangesDialog` component
- Window close handler for unsaved changes
- `saveProject()` / `saveProjectAs()` manual triggers

### Modify

**`PostRecordingPopup.tsx`**:

- "Save" button → Creates project in default location, shows success
- "Edit" button → Creates project in default location, opens editor
- Both use default location: `~/Movies/Open ScreenStudio/Recording YYYY-MM-DD HH-MM-SS.osp`

**`projectStore.ts`**:

- Add `autoSave()` that writes current project state to disk
- Call `autoSave()` after ANY state change (slice edits, config changes, etc.)
- Use debouncing to avoid excessive disk writes (e.g., 500ms delay)

**`EditorView.tsx`**:

- Remove Save/Save As buttons
- Keep only "Open" button (Cmd+O)
- Remove dirty indicator (\*)
- Remove Cmd+S shortcut

### Backend

**`src-tauri/src/commands/project.rs`**:

- Keep `create_project_from_recording` - creates project at a user-chosen location
- Keep `save_project_in_place` - renamed to `auto_save_project`
- Keep `open_project` - loads existing project

---

## Auto-Save Implementation

```typescript
// In projectStore.ts
let autoSaveTimeout: NodeJS.Timeout | null = null;

const triggerAutoSave = () => {
  // Debounce auto-save to avoid excessive disk writes
  if (autoSaveTimeout) clearTimeout(autoSaveTimeout);

  autoSaveTimeout = setTimeout(async () => {
    const { project, projectPath } = get();
    if (!project || !projectPath) return;

    try {
      await invoke("update_project", { project });
      await invoke("auto_save_project");
      console.log("Auto-saved project");
    } catch (e) {
      console.error("Auto-save failed:", e);
    }
  }, 500); // 500ms debounce
};

// Call triggerAutoSave() after any mutation:
// - updateSlice
// - removeSlice
// - splitAllTracksAt
// - updateConfig
// - addLayout
// - updateLayout
// - etc.
```

---

## New User Flow

```
1. Record → Files written to /tmp/recording-{uuid}/
2. Click "Edit" or "Save..."
   → Bundle auto-saved to default location: ~/Movies/Open ScreenStudio/
   → Filename: "Recording YYYY-MM-DD HH-MM-SS.osp"
   → project.json created with lastSavedAt
   → Editor opens (if "Edit" was clicked)
3. Make edits → Auto-saved to disk after 500ms
4. Close window → No warning (everything already saved)
5. Later: Open → Select .osp → Project loads
```

**Default Save Location**: `~/Movies/Open ScreenStudio/`

- Created automatically if doesn't exist
- User can change in Settings (future feature)
- Projects named by timestamp: `Recording 2026-01-18 14-30-45.osp`

---

## Files to Modify

| File                                              | Changes                                                                            |
| ------------------------------------------------- | ---------------------------------------------------------------------------------- |
| `src-tauri/src/commands/project.rs`               | Add `get_default_projects_dir()`, update `create_project_from_recording` to use it |
| `src/stores/projectStore.ts`                      | Add auto-save with debouncing, remove isDirty, remove manual save methods          |
| `src/components/editor/EditorView.tsx`            | Remove Save buttons, keep only Open                                                |
| `src/components/recording/PostRecordingPopup.tsx` | Both Edit and Save use default location auto-save                                  |
| `src/components/recording/RecordingToolbar.tsx`   | Update handlers to use new auto-save flow                                          |
| `src/App.tsx`                                     | Remove UnsavedChangesDialog and close handler                                      |
| `src/components/UnsavedChangesDialog.tsx`         | DELETE this file                                                                   |

---

## Verification

1. **New recording**:
   - Record → Click "Edit"
   - Project auto-saved to `~/Movies/Open ScreenStudio/Recording YYYY-MM-DD HH-MM-SS.osp`
   - Editor opens

2. **Auto-save**:
   - Make an edit (split, trim, etc.)
   - Check file system - project.json updated within ~500ms
   - No save button needed

3. **Reopen**:
   - Close editor
   - Cmd+O → Select project → Opens with all edits preserved

4. **No dirty state**:
   - Make edits → Close window → No warning dialog
   - Reopen → All changes are there
