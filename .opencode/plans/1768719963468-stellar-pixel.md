# Editing Feature Implementation Plan

## Overview

Add timeline-based video editing to Open ScreenStudio with:

- **Timeline with cuts**: Trim + split clips, rearrange order
- **Full preview rendering**: Real-time cursor smoothing, layout changes during playback
- **Basic layout switching**: Toggle between screen-only, screen-with-camera, side-by-side
- **Deferred**: Zoom features (will be added later)

## Current State

The app already has:

- Complete type definitions for `Slice`, `Layout`, `Scene` in `src/types/project.ts:131-179`
- Video preview with cursor smoothing in `src/components/editor/EditorView.tsx`
- Basic seek timeline (click-to-seek bar)
- `projectStore.ts` with `updateConfig()` but no slice/layout manipulation

What's missing:

- Timeline UI for visualizing and editing slices
- Store actions for manipulating slices/layouts
- Slice-aware playback (currently plays straight through)
- Layout rendering in preview

---

## Architecture

### New Files

```
src/
├── components/editor/
│   └── timeline/
│       ├── Timeline.tsx           # Main timeline container
│       ├── TimelineTrack.tsx      # Track component (video, layouts)
│       ├── SliceItem.tsx          # Draggable slice with trim handles
│       ├── LayoutTrack.tsx        # Layout indicator track
│       ├── Playhead.tsx           # Current position indicator
│       └── TimeRuler.tsx          # Time scale markers
│
├── stores/
│   ├── editorStore.ts             # NEW: Editor UI state (selection, tool, zoom)
│   └── playbackStore.ts           # NEW: Playback state (currentTime, isPlaying)
│
└── utils/
    ├── sliceUtils.ts              # NEW: Time conversion utilities
    └── layoutUtils.ts             # NEW: Layout position calculations
```

### Modified Files

- `src/stores/projectStore.ts` - Add slice/layout CRUD actions
- `src/components/editor/EditorView.tsx` - Integrate timeline, use stores
- `src/components/editor/WebcamOverlay.tsx` - Support layout changes

---

## Implementation Phases

### Phase 1: Foundation (Store & Utilities)

**Goal**: Basic slice data manipulation without UI changes

**Files to create/modify**:

1. **`src/stores/playbackStore.ts`** (NEW)

   ```typescript
   interface PlaybackState {
     currentTimeMs: number; // Output time (after edits)
     isPlaying: boolean;
     totalDurationMs: number;
     // Actions
     setCurrentTime: (ms: number) => void;
     play: () => void;
     pause: () => void;
     togglePlayPause: () => void;
   }
   ```

2. **`src/stores/editorStore.ts`** (NEW)

   ```typescript
   interface EditorState {
     selectedSliceId: string | null;
     selectedLayoutId: string | null;
     activeTool: "select" | "split" | "trim";
     timelineZoom: number;
     // Actions
     selectSlice: (id: string | null) => void;
     setActiveTool: (tool) => void;
   }
   ```

3. **`src/stores/projectStore.ts`** (MODIFY)
   Add actions:
   - `initializeFromRecording(durationMs)` - Create default scene with one slice
   - `addSlice(sceneIndex, slice)`
   - `updateSlice(sceneIndex, sliceId, updates)`
   - `removeSlice(sceneIndex, sliceId)`
   - `splitSlice(sceneIndex, sliceId, splitTimeMs)`
   - `reorderSlices(sceneIndex, fromIndex, toIndex)`
   - `addLayout(sceneIndex, layout)`
   - `updateLayout(sceneIndex, layoutId, updates)`
   - `removeLayout(sceneIndex, layoutId)`

4. **`src/utils/sliceUtils.ts`** (NEW)

   ```typescript
   // Convert output time to source time and slice index
   outputTimeToSource(slices, outputTimeMs) => { sliceIndex, sourceTimeMs }

   // Convert source time within a slice to output time
   sourceTimeToOutput(slices, sliceIndex, sourceTimeMs) => outputTimeMs

   // Calculate output start time of a slice
   calculateSliceOutputStart(slices, index) => number

   // Calculate total duration of all slices
   calculateTotalDuration(slices) => number
   ```

**Verification**: Unit tests for sliceUtils, manual verification that store actions work

---

### Phase 2: Timeline UI

**Goal**: Visual timeline showing slices, playhead, click-to-seek

**Files to create**:

1. **`src/components/editor/timeline/Timeline.tsx`**
   - Container with tracks and ruler
   - Props: `slices`, `layouts`, `currentTimeMs`, `onSeek`
   - Handles timeline zoom/scroll

2. **`src/components/editor/timeline/TimeRuler.tsx`**
   - Time markers (0:00, 0:05, 0:10, etc.)
   - Adapts to zoom level

3. **`src/components/editor/timeline/TimelineTrack.tsx`**
   - Generic track container with label
   - Renders children (slices or layouts)

4. **`src/components/editor/timeline/SliceItem.tsx`**
   - Visual representation of a slice
   - Shows time range, selection state
   - (Trim handles added in Phase 3)

5. **`src/components/editor/timeline/Playhead.tsx`**
   - Vertical line at current position
   - Draggable for seeking

**Modify `EditorView.tsx`**:

- Replace simple progress bar with `<Timeline />`
- Wire up seek functionality

**Verification**: Timeline displays, playhead moves during playback, click to seek works

---

### Phase 3: Slice Editing

**Goal**: Trim, split, and reorder slices

**Add to existing files**:

1. **`SliceItem.tsx`** - Add trim handles
   - Left handle: drag to adjust `sourceStartMs`
   - Right handle: drag to adjust `sourceEndMs`
   - Minimum slice duration constraint (100ms)

2. **Split functionality**:
   - Click on timeline with split tool active
   - Or keyboard shortcut (S key) at playhead position
   - Calls `projectStore.splitSlice()`

3. **Reorder functionality**:
   - Drag slice to new position
   - Visual drop indicator
   - Calls `projectStore.reorderSlices()`

4. **Slice-aware playback** in `EditorView.tsx`:
   - When video reaches end of slice, seek to start of next
   - Handle gaps between slices (if any removed content)
   - Update cursor lookup to use source time

**Verification**:

- Can trim slice boundaries, preview reflects changes
- Can split a slice into two
- Can drag slices to reorder
- Playback correctly skips removed portions

---

### Phase 4: Layout Support

**Goal**: Add/edit layouts, preview renders them

**Files to create**:

1. **`src/components/editor/timeline/LayoutTrack.tsx`**
   - Horizontal track below video track
   - Shows layout regions with colors/labels
   - Click to add layout at current time

2. **`src/utils/layoutUtils.ts`**

   ```typescript
   // Find active layout at a given time
   findLayoutAtTime(layouts, outputTimeMs) => Layout | null

   // Calculate camera position for layout type
   calculateCameraPosition(layout, containerWidth, containerHeight) => Rect
   ```

**Modify**:

1. **`WebcamOverlay.tsx`**
   - Accept `currentLayout` prop
   - Render differently based on layout type:
     - `screen-only`: hide webcam
     - `camera-only`: fullscreen webcam
     - `screen-with-camera`: PiP at `cameraPosition`
     - `side-by-side`: 50/50 split

2. **`EditorView.tsx`**
   - Look up current layout at playhead time
   - Pass to WebcamOverlay
   - Animate layout transitions (300ms CSS transition)

**Verification**:

- Can add layouts on timeline
- Preview shows correct layout at each time
- Transitions animate smoothly

---

### Phase 5: Polish

**Goal**: Keyboard shortcuts, edge cases, performance

**Add**:

1. **Keyboard shortcuts**:
   - `Space`: play/pause
   - `←/→`: frame step (Shift for 1 second)
   - `S`: split at playhead
   - `Delete/Backspace`: remove selected slice
   - `1-4`: quick layout switch (screen-only, etc.)

2. **Edge cases**:
   - Empty slices array handling
   - Prevent invalid trim (slice < 100ms)
   - Audio sync across slice boundaries

3. **Performance**:
   - Memoize timeline tracks (only re-render on slice changes)
   - Playhead updates via RAF, separate from tracks

**Verification**: Full end-to-end test of editing workflow

---

## Key Implementation Details

### Time Conversion

Slices map source video time to output time. A recording with:

```
Slice 1: sourceStart=0, sourceEnd=5000 (5 seconds)
Slice 2: sourceStart=10000, sourceEnd=15000 (5 seconds, skipped 5s in middle)
```

Produces 10 seconds of output, but source times are non-contiguous.

```typescript
// Output time 7000ms (7 seconds into final video)
// = Slice 2, sourceTime = 10000 + 2000 = 12000ms in original
```

### Preview Strategy

Use HTML5 `<video>` element (hardware decoding) + seek through slices:

- Monitor `timeupdate` events
- When reaching slice end, seek to next slice start
- Canvas overlay for cursor/click indicators (already implemented)

### Layout Rendering

Current `WebcamOverlay` is fixed position. Modify to:

1. Accept `Layout` prop
2. Calculate position/size based on layout type
3. Use CSS transitions for smooth changes

---

## Files Summary

| File                                               | Action | Description                        |
| -------------------------------------------------- | ------ | ---------------------------------- |
| `src/stores/playbackStore.ts`                      | CREATE | Playback state (time, playing)     |
| `src/stores/editorStore.ts`                        | CREATE | Editor UI state (selection, tool)  |
| `src/stores/projectStore.ts`                       | MODIFY | Add slice/layout CRUD actions      |
| `src/utils/sliceUtils.ts`                          | CREATE | Time conversion utilities          |
| `src/utils/layoutUtils.ts`                         | CREATE | Layout position calculations       |
| `src/components/editor/timeline/Timeline.tsx`      | CREATE | Main timeline container            |
| `src/components/editor/timeline/TimeRuler.tsx`     | CREATE | Time markers                       |
| `src/components/editor/timeline/TimelineTrack.tsx` | CREATE | Track wrapper                      |
| `src/components/editor/timeline/SliceItem.tsx`     | CREATE | Slice with trim handles            |
| `src/components/editor/timeline/LayoutTrack.tsx`   | CREATE | Layout regions                     |
| `src/components/editor/timeline/Playhead.tsx`      | CREATE | Position indicator                 |
| `src/components/editor/EditorView.tsx`             | MODIFY | Integrate timeline, slice playback |
| `src/components/editor/WebcamOverlay.tsx`          | MODIFY | Layout-aware rendering             |

---

## Verification Plan

After each phase, verify:

1. **Phase 1**: Run `bun run build` to check types. Manually test store actions in browser console.

2. **Phase 2**: Visual inspection - timeline renders, playhead moves, seeking works.

3. **Phase 3**:
   - Trim a slice, verify preview reflects shorter duration
   - Split a slice, verify two separate slices appear
   - Reorder slices, verify playback order changes

4. **Phase 4**:
   - Add layout change mid-video
   - Verify webcam moves/hides at correct time

5. **Phase 5**:
   - Test all keyboard shortcuts
   - Test export still works with edited project
   - Run `bun run lint` and `bun run build`

---

## Estimated Effort

- **Phase 1**: 2-3 hours (stores, utilities)
- **Phase 2**: 3-4 hours (timeline UI)
- **Phase 3**: 4-5 hours (slice editing + playback)
- **Phase 4**: 3-4 hours (layouts)
- **Phase 5**: 2-3 hours (polish)

**Total**: ~15-20 hours of implementation
